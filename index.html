<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Return Your Device ‚Äì USPS Ground Advantage‚Ñ¢ Returns</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .wrap { max-width: 720px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 8px; }
    .note { text-align: center; font-size: 14px; margin-bottom: 18px; }
    label { display: block; margin-top: 12px; font-size: 13px; }
    input, select {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #999;
      border-radius: 2px;
      background: #eaf2ff;
      box-sizing: border-box;
    }
    input.optional, select.optional { background: #fff; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    button {
      width: 100%;
      margin-top: 16px;
      padding: 12px;
      background: #444;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .box {
      margin-top: 16px;
      padding: 12px;
      border: 2px solid #ccc;
      background: #fff;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .ok { border-color: #2e8b57; background: #f2fff6; }
    .err { border-color: #cc0000; background: #fff5f5; }
    .btnlink {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 12px;
      background: #0b5bd3;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
    }
    .btnlink.secondary { background: #2f6f3a; }
    .small { font-size: 12px; color: #555; margin-top: 6px; }

    /* Tiny spinner */
    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.45);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
    }
    button.loading .spinner { display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚úÖ NEW: subtle divider under logo */
    .logo-divider {
      border: none;
      border-top: 1px solid #ddd;
      margin: 12px 0 20px;
    }

    /* ‚úÖ NEW: powered footer */
    .powered-footer {
      margin-top: 32px;
      padding-top: 12px;
      border-top: 1px solid #e5e5e5;
      text-align: center;
      font-size: 12px;
      color: #666;
    }
    .powered-footer a {
      color: #0b5bd3;
      text-decoration: none;
      font-weight: 600;
    }
    .powered-footer a:hover { text-decoration: underline; }

    /* ‚úÖ NEW: mobile polish */
    @media (max-width: 480px) {
      .powered-footer { font-size: 11px; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- ‚úÖ Logo (clickable) -->
  <div style="text-align:center; margin-bottom:16px;">
    <a href="https://www.connectamerica.com"
       target="_blank"
       rel="noopener noreferrer"
       aria-label="Connect America website">
      <img
        src="/connect-america-logo.jpg"
        alt="Connect America"
        style="max-width:180px; width:100%; height:auto;"
      />
    </a>
  </div>

  <!-- ‚úÖ Divider line under logo -->
  <hr class="logo-divider">

  <h1>Return Your Device ‚Äì USPS Ground Advantage‚Ñ¢ Returns</h1>

  <!-- PDF link at the top (served from repo root) -->
  <div style="text-align:center; margin-bottom:14px;">
    <a href="/power-off-instructions.pdf"
       target="_blank"
       rel="noopener noreferrer"
       style="font-size:14px; font-weight:bold;">
      üìÑ Power-Off Instructions (PDF)
    </a>
    <div class="small">
      Please review before returning your device.
    </div>
  </div>

  <div class="note">
    This form generates a <b>return shipping label</b>.<br>
    Fields marked * are required.
  </div>

  <form id="frm" autocomplete="off">
    <label>Full Name *</label>
    <input id="name" required placeholder="Full Name">

    <label>Email (optional)</label>
    <input id="email" class="optional" placeholder="Email (optional)">

    <label>Device Type *</label>
    <select id="deviceType" required>
      <option value="" selected disabled>Select your device‚Ä¶</option>
      <option value="Cellular Assure / Mytrex|2">Cellular Assure / Mytrex ‚Äî 2 lb</option>
      <option value="Mytrex Landline|2">Mytrex Landline ‚Äî 2 lb</option>
      <option value="On the Go|1">On the Go ‚Äî 1 lb</option>
      <option value="OTG Micron|1">OTG Micron ‚Äî 1 lb</option>
      <option value="OTG Mini Neck|1">OTG Mini Neck ‚Äî 1 lb</option>
      <option value="OTG Mini Wrist|1">OTG Mini Wrist ‚Äî 1 lb</option>
      <option value="Smartwatch|1">Smartwatch ‚Äî 1 lb</option>
      <option value="Mobile LTE|1">Mobile LTE ‚Äî 1 lb</option>
      <option value="Other|2">Other ‚Äî 2 lb</option>
    </select>
    <div class="small">Weight is automatically set based on device type.</div>

    <label>Street Address *</label>
    <input id="address1" required placeholder="Street Address">

    <label>Apt / Suite (optional)</label>
    <input id="address2" class="optional" placeholder="Apt / Suite">

    <div class="row">
      <div>
        <label>City *</label>
        <input id="city" required placeholder="City">
      </div>
      <div>
       <label>State *</label>
<select id="state" required>
  <option value="" selected disabled>Select State‚Ä¶</option>
  <option value="AL">Alabama</option>
  <option value="AK">Alaska</option>
  <option value="AZ">Arizona</option>
  <option value="AR">Arkansas</option>
  <option value="CA">California</option>
  <option value="CO">Colorado</option>
  <option value="CT">Connecticut</option>
  <option value="DE">Delaware</option>
  <option value="FL">Florida</option>
  <option value="GA">Georgia</option>
  <option value="HI">Hawaii</option>
  <option value="ID">Idaho</option>
  <option value="IL">Illinois</option>
  <option value="IN">Indiana</option>
  <option value="IA">Iowa</option>
  <option value="KS">Kansas</option>
  <option value="KY">Kentucky</option>
  <option value="LA">Louisiana</option>
  <option value="ME">Maine</option>
  <option value="MD">Maryland</option>
  <option value="MA">Massachusetts</option>
  <option value="MI">Michigan</option>
  <option value="MN">Minnesota</option>
  <option value="MS">Mississippi</option>
  <option value="MO">Missouri</option>
  <option value="MT">Montana</option>
  <option value="NE">Nebraska</option>
  <option value="NV">Nevada</option>
  <option value="NH">New Hampshire</option>
  <option value="NJ">New Jersey</option>
  <option value="NM">New Mexico</option>
  <option value="NY">New York</option>
  <option value="NC">North Carolina</option>
  <option value="ND">North Dakota</option>
  <option value="OH">Ohio</option>
  <option value="OK">Oklahoma</option>
  <option value="OR">Oregon</option>
  <option value="PA">Pennsylvania</option>
  <option value="RI">Rhode Island</option>
  <option value="SC">South Carolina</option>
  <option value="SD">South Dakota</option>
  <option value="TN">Tennessee</option>
  <option value="TX">Texas</option>
  <option value="UT">Utah</option>
  <option value="VT">Vermont</option>
  <option value="VA">Virginia</option>
  <option value="WA">Washington</option>
  <option value="WV">West Virginia</option>
  <option value="WI">Wisconsin</option>
  <option value="WY">Wyoming</option>
</select>

      </div>
    </div>

    <div class="row">
      <div>
        <label>ZIP *</label>
        <input id="zip" required placeholder="ZIP Code">
      </div>
      <div>
        <label>Phone *</label>
        <input id="phone" required placeholder="Phone Number">
      </div>
    </div>

    <label>Device Serial (optional)</label>
    <input id="deviceSerial" class="optional" placeholder="Device Serial">

    <button id="btn" type="submit">
      <span class="spinner" aria-hidden="true"></span>
      <span id="btnText">Generate Return Label</span>
    </button>

    <div class="small" style="margin-top:10px;">
      Note: Label generation may take <b>1‚Äì2 minutes</b> depending on carrier response time. Please do not refresh the page.
    </div>
  </form>

  <div id="out"></div>

  <!-- ‚úÖ NEW footer -->
  <footer class="powered-footer">
    Powered by
    <a href="https://www.connectamerica.com"
       target="_blank"
       rel="noopener noreferrer">
      Connect America
    </a>
  </footer>

  <div class="small" style="margin-top:12px;">
    Build: 2026-01-28
  </div>
</div>

<script>
const frm = document.getElementById('frm');
const out = document.getElementById('out');
const btn = document.getElementById('btn');
const btnText = document.getElementById('btnText');

function show(type, html, asHtml = true) {
  out.innerHTML = `<div class="box ${type || ''}">${asHtml ? html : escapeHtml(html)}</div>`;
}

function escapeHtml(s) {
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function base64ToBlob(b64) {
  const bytes = atob(b64);
  const arr = new Uint8Array(bytes.length);
  for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
  return new Blob([arr], { type: 'application/pdf' });
}

function setLoading(isLoading) {
  btn.disabled = isLoading;
  btn.classList.toggle('loading', isLoading);
  btnText.textContent = isLoading ? 'Generating (may take 1‚Äì2 minutes)‚Ä¶' : 'Generate Return Label';
}

frm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const dt = document.getElementById('deviceType').value;
  if (!dt) {
    show('err', '‚ùå Please select a Device Type.', false);
    return;
  }

  const [deviceType, weightLbsStr] = dt.split('|');
  const weightLbs = Number(weightLbsStr || 2);
  const weightOz = weightLbs * 16;

  setLoading(true);
  show('', 'Working‚Ä¶', false);

  const payload = {
    name: document.getElementById('name').value.trim(),
    email: document.getElementById('email').value.trim(),
    deviceType,
    weightLbs,
    weightOz,

    address1: document.getElementById('address1').value.trim(),
    address2: document.getElementById('address2').value.trim(),
    city: document.getElementById('city').value.trim(),
    state: document.getElementById('state').value.trim(),
    zip: document.getElementById('zip').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    deviceSerial: document.getElementById('deviceSerial').value.trim()
  };

  try {
    const resp = await fetch('/api/create-label', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await resp.json().catch(() => null);

    if (!data) {
      show('err', `ERROR: API returned non-JSON response. HTTP ${resp.status}`, false);
      return;
    }

    if (!resp.ok || !data.ok) {
      show('err', `‚ùå API ERROR (HTTP ${resp.status})\n\n${escapeHtml(JSON.stringify(data, null, 2))}`);
      return;
    }

    const blob = base64ToBlob(data.labelData);
    const url = URL.createObjectURL(blob);

    // auto-download
    const a = document.createElement('a');
    a.href = url;
    a.download = data.filename || 'usps-return-label.pdf';
    document.body.appendChild(a);
    a.click();
    a.remove();

    const trackingLine = data.trackingNumber
      ? `<div style="margin-top:8px;">Tracking: <b>${escapeHtml(data.trackingNumber)}</b></div>`
      : '';

    show('ok', `
      <div>‚úÖ <b>Return label created successfully.</b></div>
      <div style="margin-top:6px;">Please <b>print the label</b> before scheduling USPS pickup.</div>

      <div style="margin-top:10px;">
        <a class="btnlink" href="${url}" download>Download Label Again</a>
      </div>

      <div style="margin-top:10px;">
        <b>Device:</b> ${escapeHtml(deviceType)}<br/>
        <b>Package Weight:</b> ${escapeHtml(String(weightLbs))} lb
      </div>

      ${trackingLine}

      <div style="margin-top:14px; border-top:1px solid #cfe7d5; padding-top:12px;">
        <div><b>Need a free USPS pickup?</b></div>
        <div style="margin-top:6px;">Schedule a free pickup with USPS for this return.</div>
        <div style="margin-top:10px;">
          <a class="btnlink secondary"
             href="https://tools.usps.com/schedule-pickup-steps.htm"
             target="_blank"
             rel="noopener noreferrer">
            Schedule Free USPS Pickup
          </a>
        </div>
        <div class="small" style="margin-top:8px;">
          On the USPS page set:
          <ul style="margin:6px 0 0 18px;">
            <li>‚ÄúUSPS Ground Advantage‚Ñ¢‚Äù quantity to <b>1</b></li>
            <li>Package weight to <b>${escapeHtml(String(weightLbs))} lb</b></li>
          </ul>
        </div>
      </div>
    `);

  } catch (err) {
    show('err', `ERROR: ${escapeHtml(String(err))}`);
  } finally {
    setLoading(false);
  }
});
</script>
</body>
</html>
