<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Connect America Return Label</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 40px auto; }
    input, select, button { width: 100%; padding: 10px; margin: 8px 0; font-size: 16px; }
    button { background-color: #0055A5; color: white; border: none; cursor: pointer; }
    button:disabled { background-color: #999; cursor: not-allowed; }
    .error { color: red; font-weight: bold; }
    .success { color: green; font-weight: bold; }
  </style>
</head>
<body>

<h2>Request a Physical Return Label</h2>

<form id="returnForm">
  <input type="text" name="name" placeholder="Full Name" required />
  <input type="text" name="address1" placeholder="Street Address" required />
  <input type="text" name="address2" placeholder="Apartment / Suite (Optional)" />
  <input type="text" name="city" placeholder="City" required />
  <input type="text" name="state" placeholder="State (e.g. PA)" required />
  <input type="text" name="zip" placeholder="ZIP Code" required />

  <select name="deviceType" required>
    <option value="">Select Device Type</option>
    <option value="1">1 lb Device</option>
    <option value="2">2 lb Device</option>
  </select>

  <button type="submit" id="submitBtn">Mail My Return Label</button>
  <div id="message"></div>
</form>

<script>
  const form = document.getElementById("returnForm");
  const messageDiv = document.getElementById("message");
  const submitBtn = document.getElementById("submitBtn");

  form.addEventListener("submit", async function(e) {
    e.preventDefault();

    messageDiv.innerHTML = "";
    messageDiv.className = "";

    submitBtn.disabled = true;
    submitBtn.innerText = "Processing... Please wait";

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch("/api/mail-label", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // NOTE: No access code is sent from the browser.
        body: JSON.stringify(data)
      });

      // If auth fails, browser will prompt for username/password automatically.
      const result = await response.json().catch(() => null);

      if (!response.ok || !result?.ok) {
        throw new Error(result?.error || "Request failed");
      }

      messageDiv.className = "success";
      messageDiv.innerHTML = `
        Success! Your return label and instructions have been mailed.<br><br>
        ${result.uspsTrackingNumber ? "USPS Tracking: " + result.uspsTrackingNumber + "<br>" : ""}
        ${result.lobLetterId ? "Mail Tracking ID: " + result.lobLetterId : ""}
      `;

      form.reset();
    } catch (err) {
      messageDiv.className = "error";
      messageDiv.innerHTML = "Error: " + err.message;
    }

    submitBtn.disabled = false;
    submitBtn.innerText = "Mail My Return Label";
  });
</script>

</body>
</html>
