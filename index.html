<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Connect America Return Label</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 650px; margin: 40px auto; }

    label { font-weight: bold; display: block; margin-top: 12px; }

    .required-star { color: red; margin-left: 4px; }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }

    input.error-field, select.error-field {
      border: 2px solid red;
      background-color: #fff5f5;
    }

    button {
      background-color: #0055A5;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 16px;
    }

    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    .error { color: red; font-weight: bold; margin-top: 12px; }
    .success { color: green; font-weight: bold; margin-top: 12px; }

    .box {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      background: #fafafa;
      font-size: 14px;
      line-height: 1.4;
    }

    .muted { color: #666; font-size: 13px; }
  </style>
</head>

<body>

<h2>Request a Physical Return Label</h2>

<form id="returnForm" novalidate>

  <label>Full Name<span class="required-star">*</span></label>
  <input type="text" name="name" required />

  <label>Street Address<span class="required-star">*</span></label>
  <input type="text" name="address1" required />

  <label>Apartment / Suite</label>
  <input type="text" name="address2" />

  <label>City<span class="required-star">*</span></label>
  <input type="text" name="city" required />

  <label>State<span class="required-star">*</span></label>
  <select name="state" required>
    <option value="">Select State</option>
    <option value="AL">Alabama (AL)</option>
    <option value="AK">Alaska (AK)</option>
    <option value="AZ">Arizona (AZ)</option>
    <option value="AR">Arkansas (AR)</option>
    <option value="CA">California (CA)</option>
    <option value="CO">Colorado (CO)</option>
    <option value="CT">Connecticut (CT)</option>
    <option value="DE">Delaware (DE)</option>
    <option value="FL">Florida (FL)</option>
    <option value="GA">Georgia (GA)</option>
    <option value="HI">Hawaii (HI)</option>
    <option value="ID">Idaho (ID)</option>
    <option value="IL">Illinois (IL)</option>
    <option value="IN">Indiana (IN)</option>
    <option value="IA">Iowa (IA)</option>
    <option value="KS">Kansas (KS)</option>
    <option value="KY">Kentucky (KY)</option>
    <option value="LA">Louisiana (LA)</option>
    <option value="ME">Maine (ME)</option>
    <option value="MD">Maryland (MD)</option>
    <option value="MA">Massachusetts (MA)</option>
    <option value="MI">Michigan (MI)</option>
    <option value="MN">Minnesota (MN)</option>
    <option value="MS">Mississippi (MS)</option>
    <option value="MO">Missouri (MO)</option>
    <option value="MT">Montana (MT)</option>
    <option value="NE">Nebraska (NE)</option>
    <option value="NV">Nevada (NV)</option>
    <option value="NH">New Hampshire (NH)</option>
    <option value="NJ">New Jersey (NJ)</option>
    <option value="NM">New Mexico (NM)</option>
    <option value="NY">New York (NY)</option>
    <option value="NC">North Carolina (NC)</option>
    <option value="ND">North Dakota (ND)</option>
    <option value="OH">Ohio (OH)</option>
    <option value="OK">Oklahoma (OK)</option>
    <option value="OR">Oregon (OR)</option>
    <option value="PA">Pennsylvania (PA)</option>
    <option value="RI">Rhode Island (RI)</option>
    <option value="SC">South Carolina (SC)</option>
    <option value="SD">South Dakota (SD)</option>
    <option value="TN">Tennessee (TN)</option>
    <option value="TX">Texas (TX)</option>
    <option value="UT">Utah (UT)</option>
    <option value="VT">Vermont (VT)</option>
    <option value="VA">Virginia (VA)</option>
    <option value="WA">Washington (WA)</option>
    <option value="WV">West Virginia (WV)</option>
    <option value="WI">Wisconsin (WI)</option>
    <option value="WY">Wyoming (WY)</option>
  </select>

  <label>ZIP Code<span class="required-star">*</span></label>
  <input type="text" name="zip" required />

  <label>Phone Number<span class="required-star">*</span></label>
  <input type="text" name="phone" required />

  <label>Package Weight<span class="required-star">*</span></label>
  <select name="deviceType" required>
    <option value="">Select Weight</option>
    <option value="1 lb Device|1">1 lb</option>
    <option value="2 lb Device|2">2 lb</option>
    <option value="3 lb Device|3">3 lb</option>
    <option value="4 lb Device|4">4 lb</option>
    <option value="5 lb Device|5">5 lb</option>
    <option value="6 lb Device|6">6 lb</option>
    <option value="7 lb Device|7">7 lb</option>
    <option value="8 lb Device|8">8 lb</option>
    <option value="9 lb Device|9">9 lb</option>
    <option value="10 lb Device|10">10 lb</option>
  </select>

  <button type="submit" id="submitBtn">Mail My Return Label</button>
  <div id="message"></div>

</form>

<script>
  const form = document.getElementById("returnForm");
  const messageDiv = document.getElementById("message");
  const submitBtn = document.getElementById("submitBtn");

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  form.addEventListener("submit", async function(e) {
    e.preventDefault();
    messageDiv.innerHTML = "";
    messageDiv.className = "";

    submitBtn.disabled = true;
    submitBtn.innerText = "Processing... Please wait";

    try {
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      const raw = data.deviceType;
      const [deviceTypeLabel, weightLbsStr] = raw.split("|");
      data.deviceType = deviceTypeLabel;
      data.weightOz = Number(weightLbsStr) * 16;

      const response = await fetch("/api/mail-label", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (!response.ok || !result.ok) {
        throw new Error(result.error || "Request failed");
      }

      messageDiv.className = "success";
      messageDiv.innerHTML = `
        Success! Your return label and instructions have been mailed.<br><br>
        USPS Tracking: ${escapeHtml(result.uspsTrackingNumber)}<br>
        Mail Tracking ID: ${escapeHtml(result.lobLetterId)}
      `;

      form.reset();
    } catch (err) {
      messageDiv.className = "error";
      messageDiv.innerHTML = "Error: " + escapeHtml(err.message);
    }

    submitBtn.disabled = false;
    submitBtn.innerText = "Mail My Return Label";
  });
</script>

</body>
</html>
