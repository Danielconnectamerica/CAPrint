<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Connect America Return Label</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 650px;
      margin: 40px auto;
    }

    /* ✅ Logo Header */
    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .header img {
      max-width: 260px;   /* adjust size if needed */
      width: 100%;
      height: auto;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    label { font-weight: bold; display: block; margin-top: 12px; }
    .required-star { color: red; margin-left: 4px; }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }

    input.error-field, select.error-field {
      border: 2px solid red;
      background-color: #fff5f5;
    }

    button {
      background-color: #0055A5;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 16px;
    }

    button:disabled { background-color: #999; cursor: not-allowed; }

    .error { color: red; font-weight: bold; margin-top: 12px; }
    .success { color: green; font-weight: bold; margin-top: 12px; }

    .box {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      background: #fafafa;
      font-size: 14px;
      line-height: 1.4;
    }

    .muted { color: #666; font-size: 13px; }
  </style>
</head>

<body>

<!-- ✅ CONNECT AMERICA LOGO -->
<div class="header">
  <img src="/connect-america-logo.jpg" alt="Connect America" />
</div>

<h2>Request a Physical Return Label</h2>

<form id="returnForm" novalidate>

  <label>Full Name<span class="required-star">*</span></label>
  <input type="text" name="name" required />

  <label>Street Address<span class="required-star">*</span></label>
  <input type="text" name="address1" required />

  <label>Apartment / Suite</label>
  <input type="text" name="address2" />

  <label>City<span class="required-star">*</span></label>
  <input type="text" name="city" required />

  <label>State<span class="required-star">*</span></label>
  <select name="state" required>
    <option value="">Select State</option>
    <!-- (State list unchanged — trimmed here for readability) -->
    <option value="PA">Pennsylvania (PA)</option>
    <option value="NJ">New Jersey (NJ)</option>
    <option value="NY">New York (NY)</option>
    <!-- keep the rest of your states exactly as before -->
  </select>

  <label>ZIP Code<span class="required-star">*</span></label>
  <input type="text" name="zip" required />

  <label>Phone Number<span class="required-star">*</span></label>
  <input type="text" name="phone" required />

  <label>Device Type<span class="required-star">*</span></label>
  <select id="deviceType" name="deviceType" required>
    <option value="" selected disabled>Select your device…</option>
    <option value="Cellular Assure / Mytrex" data-weight="2">Cellular Assure / Mytrex — 2 lb</option>
    <option value="Mytrex Landline" data-weight="2">Mytrex Landline — 2 lb</option>
    <option value="On the Go" data-weight="1">On the Go — 1 lb</option>
    <option value="OTG Micron" data-weight="1">OTG Micron — 1 lb</option>
    <option value="OTG Mini Neck" data-weight="1">OTG Mini Neck — 1 lb</option>
    <option value="OTG Mini Wrist" data-weight="1">OTG Mini Wrist — 1 lb</option>
    <option value="Smartwatch" data-weight="1">Smartwatch — 1 lb</option>
    <option value="Mobile LTE" data-weight="1">Mobile LTE — 1 lb</option>
    <option value="Other" data-weight="2">Other — 2 lb</option>
  </select>

  <label>Device Serial (Optional)</label>
  <input type="text" name="deviceSerial" placeholder="Serial Number (optional)" />

  <label>Return Reason (Optional)</label>
  <input type="text" name="returnReason" placeholder="Reason (optional)" />

  <button type="submit" id="submitBtn">Mail My Return Label</button>
  <div id="message"></div>

</form>

<script>
  const form = document.getElementById("returnForm");
  const messageDiv = document.getElementById("message");
  const submitBtn = document.getElementById("submitBtn");
  const deviceSelect = document.getElementById("deviceType");

  const weightInput = document.createElement("input");
  weightInput.type = "hidden";
  weightInput.name = "weightOz";
  form.appendChild(weightInput);

  deviceSelect.addEventListener("change", function () {
    const selected = deviceSelect.options[deviceSelect.selectedIndex];
    const weightLbs = Number(selected.getAttribute("data-weight") || 2);
    weightInput.value = String(weightLbs * 16);
  });

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function clearFieldErrors() {
    const fields = form.querySelectorAll("input, select");
    fields.forEach(f => f.classList.remove("error-field"));
  }

  function validateForm() {
    clearFieldErrors();
    const requiredFields = form.querySelectorAll("[required]");
    const missing = [];

    requiredFields.forEach(field => {
      const val = (field.value || "").trim();
      if (!val) {
        field.classList.add("error-field");
        const label = field.previousElementSibling?.textContent?.replace("*", "").trim() || field.name;
        missing.push(label);
      }
    });

    if (!weightInput.value) {
      deviceSelect.classList.add("error-field");
      if (!missing.includes("Device Type")) missing.push("Device Type");
    }

    if (missing.length) {
      messageDiv.className = "error";
      messageDiv.innerHTML =
        "Please complete the following required fields:<br><br>" +
        missing.map(m => "• " + escapeHtml(m)).join("<br>");
      return false;
    }

    return true;
  }

  form.addEventListener("submit", async function(e) {
    e.preventDefault();
    messageDiv.innerHTML = "";
    messageDiv.className = "";

    if (!validateForm()) return;

    submitBtn.disabled = true;
    submitBtn.innerText = "Processing... Please wait";

    try {
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      const response = await fetch("/api/mail-label", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await response.json().catch(() => null);

      if (!response.ok || !result?.ok) {
        throw new Error(result?.error || "Request failed");
      }

      messageDiv.className = "success";
      messageDiv.innerHTML = `
        Success! Your return label and instructions have been mailed.<br><br>
        ${result.uspsTrackingNumber ? "USPS Tracking: " + escapeHtml(result.uspsTrackingNumber) + "<br>" : ""}
        ${result.lobLetterId ? "Mail Tracking ID: " + escapeHtml(result.lobLetterId) : ""}
      `;

      form.reset();
      weightInput.value = "";

    } catch (err) {
      messageDiv.className = "error";
      messageDiv.innerHTML = "Error: " + escapeHtml(err.message);
    }

    submitBtn.disabled = false;
    submitBtn.innerText = "Mail My Return Label";
  });
</script>

</body>
</html>
